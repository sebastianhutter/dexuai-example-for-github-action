name: AWS Deployment Example

on:
  # Trigger manually for demonstration purposes
  workflow_dispatch:
  # Or trigger on push to main
  # push:
  #   branches:
  #     - main

# These permissions are required for OIDC authentication
permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 474350780167
  EKS_CLUSTER_NAME: dexu-ai-eks-stage-01
  EC2_INSTANCE_ID: i-05e3672fad96b8167 # instance id for ssm example (worker-node-stage-instance), the step will only work if the instance is running!

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Replace with your AWS IAM role ARN
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github-action-role-${{ env.AWS_REGION }}
          aws-region: ${{ env.AWS_REGION }}
          # Optional: Add role session name for better tracking
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Verify AWS identity
        run: |
          echo "Verifying AWS credentials..."
          aws sts get-caller-identity

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ECR Registry: $ECR_REGISTRY"
          echo "Image would be pushed to: $ECR_REGISTRY/myawesomeimage:$IMAGE_TAG"

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Configure kubectl for EKS
        run: |
          echo "Configuring kubectl to connect to EKS cluster..."
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Verify EKS connection
        run: |
          echo "Testing EKS cluster connection..."
          kubectl cluster-info
          kubectl get nodes
          kubectl get namespaces

      - name: Deploy EKS example pod
        run: |
          cat << 'EOF' | kubectl apply -f -
          apiVersion: v1
          kind: Pod
          metadata:
            name: hello-world-pod
            labels:
              app: hello-world
          spec:
            containers:
            - name: hello-world
              image: nginx:latest
              ports:
              - containerPort: 80
            restartPolicy: Never
          EOF

          echo "Pod deployed successfully!"
          kubectl get pod hello-world-pod
          kubectl describe pod hello-world-pod
          kubectl logs hello-world-pod
          kubectl delete pod hello-world-pod
      - name: Example AWS Parameter Store retrieval
        run: |
          echo "Retrieving a parameter from AWS SSM Parameter Store..."
          aws ssm get-parameter --name "/koryo/github-action/example-parameter" --with-decryption

      - name: Example AWS S3 List bucket
        run: |
          echo "Listing contents of S3 bucket..."
          echo "This permission is managed in the customer inline policy which you can modify at any time"
          echo "see staging role: https://us-east-1.console.aws.amazon.com/iam/home?region=us-east-1#/roles/details/github-action-role-us-east-1"

          aws s3 ls s3://assets-dexu-ai-stage-s3-nvirginia/

      - name: Example EC2 ssm command
        run: |
          echo "Sending a command to EC2 instance via SSM..."
          echo "ATTENTION: this will only work if the instance is running!"
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions SSM Command Example" \
            --parameters commands=["echo Hello from GitHub Actions!"] \
            --query "Command.CommandId" \
            --output text)

          echo "Command sent. Command ID: $COMMAND_ID"

          sleep 5
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ env.EC2_INSTANCE_ID }}"
